id: org.freedesktop.Sdk.Extension.haxe
runtime: org.freedesktop.Sdk
branch: "23.08"
build-extension: true
sdk: org.freedesktop.Sdk
runtime-version: "23.08"
separate-locales: false
modules:
  - name: ocaml
    sources:
      - type: git
        url: https://github.com/ocaml/ocaml
        tag: 5.2.0
        commit: 74a76cc2f2588eb18a443a60918f040838292ac7
        x-checker-data:
          - type: git
            tag-pattern: ^([\\d.]+)$
  - name: pcre2
    config-opts: [--enable-unicode-properties]
    sources:
      - type: archive
        url: https://github.com/PCRE2Project/pcre2/releases/download/pcre2-10.44/pcre2-10.44.tar.bz2
        sha256: d34f02e113cf7193a1ebf2770d3ac527088d485d4e047ed10e5d217c6ef5de96
        x-checker-data:
          - type: anitya
            project-id: 5832
            stable-only: true
            url-template: https://github.com/PCRE2Project/pcre2/releases/download/pcre2-$version/pcre2-$version.tar.bz2
  - name: zlib
    sources:
      - type: archive
        url: https://github.com/madler/zlib/releases/download/v1.3.1/zlib-1.3.1.tar.gz
        sha256: 9a93b2b7dfdac77ceba5a558a580e74667dd6fede4585b91eefb60f03b72df23
        x-checker-data:
          - type: anitya
            project-id: 5303
            stable-only: true
            url-template: https://github.com/madler/zlib/releases/download/v$version/zlib-$version.tar.gz
  - name: neko
    buildsystem: simple
    sources:
      - type: archive
        only-arches: [x86_64]
        url: https://github.com/HaxeFoundation/neko/releases/download/v2-4-0/neko-2.4.0-linux64.tar.gz
        sha256: 0a57a3eca92359da75eb0500a15766319f45e8f9eb7cc105f9f40391946b2ce7
        x-checker-data:
          - type: json
            url: https://api.github.com/repos/HaxeFoundation/neko/releases/latest
            version-query: .name
            url-query: .assets[] | select(.name==\"neko-\" + $version + \"-linux64.tar.gz\") | .browser_download_url
      - type: archive
        only-arches: [aarch64]
        url: https://github.com/HaxeFoundation/neko/releases/download/v2-4-0/neko-2.4.0-linux-arn64.tar.gz
        sha256: 0f0b7fdd665f77d10a79834f40c9c7add7d4a9e8acd6e016bce38aa4319c7379
        x-checker-data:
          - type: json
            url: https://api.github.com/repos/HaxeFoundation/neko/releases/latest
            version-query: .name
            url-query: .assets[] | select(.name==\"neko-\" + $version + \"-linux-arm64.tar.gz\") | .browser_download_url
    build-commands:
      - mkdir $FLATPAK_DEST/bin/
      - mkdir $FLATPAK_DEST/lib/
      - mkdir $FLATPAK_DEST/linclude/
      - install -Dm755 *.ndll $FLATPAK_DEST/bin/
      - install -Dm755 neko* $FLATPAK_DEST/bin/
      - install -Dm755 libneko.so* $FLATPAK_DEST/lib/
      - cp -r include $FLATPAK_DEST/linclude/
  # TODO: Somehow add HashLink (build from source)
  - name: haxe
    buildsystem: simple
    no-autogen: true
    sources:
      - type: git
        url: https://github.com/HaxeFoundation/haxe/
        tag: 4.3.5
        commit: bd79571b89d719a45db7860d239da2164147dd15
        x-checker-data:
          - type: git
            tag-pattern: ^([\\d.]+)$
    build-commands:
      - make -j $FLATPAK_BUILDER_N_JOBS
      - make install -j $FLATPAK_BUILDER_N_JOBS